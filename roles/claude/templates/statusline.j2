#!/usr/bin/env python3
import json
import sys
import os
import subprocess

# ANSI colors
BLUE = '\033[34m'
GREEN = '\033[32m'
RED = '\033[31m'
ORANGE = '\033[33m'
RESET = '\033[0m'

# Read JSON from stdin
data = json.load(sys.stdin)

# Extract values
model_name = data['model']['display_name']
current_dir = os.path.basename(data['workspace']['current_dir'])
cost = data['cost']['total_cost_usd']
used_context = data['context_window']['used_percentage']

# Check for git branch
git_branch = ""
if os.path.exists('.git'):
    try:
        with open('.git/HEAD', 'r') as f:
            ref = f.read().strip()
            if ref.startswith('ref: refs/heads/'):
                branch_name = ref.replace('ref: refs/heads/', '')

                # Check for file changes
                result = subprocess.run(
                    ['git', 'status', '--porcelain'],
                    capture_output=True,
                    text=True
                )

                stats = ""
                if result.stdout.strip():
                    lines = result.stdout.strip().split('\n')
                    modified = sum(1 for l in lines if l[0:2] in (' M', 'M ', 'MM'))
                    added = sum(1 for l in lines if l[0:2] == 'A ' or l[0:2] == '??')
                    deleted = sum(1 for l in lines if 'D' in l[0:2])
                    parts = []
                    if modified: parts.append(f"{ORANGE}~{modified}{RESET}")
                    if added: parts.append(f"{GREEN}+{added}{RESET}")
                    if deleted: parts.append(f"{RED}-{deleted}{RESET}")
                    if parts: stats = f" [{' '.join(parts)}]"

                git_branch = f" âŽ‡ {branch_name}{stats}"
    except:
        pass

print(f"{current_dir}{git_branch} | ðŸ¤– {BLUE}{model_name}{RESET} | {cost:.2f}$ | {used_context}% ctx")
